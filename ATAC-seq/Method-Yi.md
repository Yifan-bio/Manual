# This file records the description of the ATAC methods Yi used in his Master Project.
> Yi Fan Xu - graduated in 2024

## Read Trim

Illumina sequencing library preparation includes the attachment of adapter sequences to the ends of the fragment, which facilitates the sequencing process. When short input fragments are used, there is a potential for adapter regions located at the 3' end of the fragment to be sequenced erroneously, especially when the sequencing read length exceeds the fragment length (Martin, 2011). Illumina sequencing data also encounters a decline in quality due to phasing, resulting in a reduction in the sequencing quality at the end of reads (Figure 2.1B; Ledergerber and Dessimoz, 2011). Phasing refers to inconsistencies in the Illumina signal, arising when a subset of amplicons reflect the fluorescent signal of different base pairs due to a delay in the reaction. Both phenomena have been reported to introduce a bias in the alignment of reads (Yu et al., 2012). To address this issue, trimming was performed to remove the low-quality 3' end and adapter sequences, thereby reducing potential interference during read alignment.

The trimming process was performed using Trim Galore (Krueger et al., 2021), which integrates cutadapt (Martin, 2011) to remove low-quality bases and adapter sequences located at the 3' end of sequencing reads. Trim Galore was chosen for its ability to correctly identify the adapter sequence for each library. The trimming process was applied exclusively to the ATAC-seq sequencing reads included in this study, as the necessary base-to-base alignment required for analysis makes it vulnerable to misalignment caused by low quality reads and adapter sequencing. The RNA-seq reads were not subjected to trimming, as trimming has been suggested to introduce unwanted bias during gene quantification (Williams et al., 2016; Liao and Shi, 2020). These studies have suggested that trimming RNA-seq libraries can lead to false read alignment due to the reduced read length.

Trim Galore applies single-end trimming, using cutadapt on each fastq library, followed by a comparison of the trimmed pairs at a later stage (Krueger et al., 2021). The single-end trimming consists of three steps: removing low-quality bases, trimming adapter sequences, and eliminating short reads. At the beginning of the trimming process, consecutive low-quality bases (Phred score < 20) at the 3' end are removed until a Phred score above 20 is encountered. The remaining adapter sequences in quality-trimmed reads are then removed. Trim Galore automatically detected the adapter sequence of the ATAC-seq reads as the Illumina universal adapter (AGATCGGAAGAGC) by comparing the 3' end of the first million sequences to the pre-loaded adapter sequence database. In the third stage of trimming, reads with fewer than 20 bp were removed due to the high likelihood of multi-mapping. The final step performed by Trim Galore, triggered by the -paired flag, removes the corresponding partner of all reads that were eliminated due to trimming. The remaining trimmed and paired fastq files were then used in genome alignment.

##	Sequencing read alignment

The alignment of DNA libraries is commonly performed using either BWA (Li and Durbin, 2009, 2010) or Bowtie2 (Langmead and Salzberg, 2012), both of which offer similar levels of speed, accuracy, and alignment rate (Hatem et al., 2013; Thankaswamy-Kosalai et al., 2017; Langmead et al., 2019). For the alignment of ATAC-seq reads in this study, Bowtie2 v2.4.5 (Langmead and Salzberg, 2012) was used to align against the GRCh38 primary human genome sequence. Bowtie2 offers rapid and precise alignment, enabling gapped alignment of paired-end reads, and has been found to be most effective for reads with lengths longer than 50 bp (Langmead and Salzberg, 2012; Langmead et al., 2019). 

The genome alignment index was generated using the bowtie2-build command. Bowtie2 employs the FM-index technique (Ferragina and Manzini, 2000), extended from the Burrow-Wheeler transform (Na et al., 2018), to reduce the memory footprint of comparing the reference and reads (Ferragina and Manzini, 2000). In the implementation of FM-index techniques, the genome reference is organised to facilitate the efficient alignment of queried reads to the genome.

The Bowtie2 algorithm employs a seed-and-extend approach for base-to-base alignment, allowing for efficient and accurate identification of alignment positions (Langmead and Salzberg, 2012). This approach divides all queried reads into seeds, with each seed representing a section of the read. All the seeds are aligned with the FM-index to identify locations with an exact match for each seed. Once a potential location for a seed is detected, the algorithm records it and continues the exact match search until all potential locations for all seeds are found (Langmead et al., 2009). This ungapped alignment of seeds is conducted to minimise the resources and time needed for read alignments. This is because aligning full reads directly will not account for gapped alignment, unless massive resources are allocated (Ahmed et al., 2016). 

Following the identification of potential matches for all seeds, each ungapped location is extended within the reference genome (Langmead and Salzberg, 2012). In this process, a backtrack algorithm will score the likelihood of the entire read being aligned, providing a penalty score that takes into account both indels and mismatch events. By using this approach, only regions with at least a partial map will be queried for full read alignment, thus reducing the computational resources required. The process also employs a dynamic programming approach to run parallel processing of seed extension, minimising the computational runtime needed for extension (Langmead and Salzberg, 2012). The extension step is performed until a sufficient number of alignments are examined, or until the dynamic programming effort limit is reached .

During this study, the --very-sensitive mode of Bowtie2 alignment, which employs an end-to-end alignment approach, was used. The high sensitivity mode produces alignment seeds that are 20 bp long from the input reads, with an interval of approximately 5 bp between each seed (Langmead and Salzberg, 2012). In other words, each input read will be divided into multiple seeds, and adjacent seeds will consist of 15 identical base pairs. The requirement of only concordantly paired-end mapped results to be valid (--no-mixed), with a maximum gap of 2 000 bp (-X 2000) was also specified. This value was selected because the majority of accessible regions fall within the length range of 70 to 600 bp, and fragments above 2 000 bp have been found to fail during Illumina sequencing (Buenrostro et al., 2013a; Grandi et al., 2022). Additionally, dovetail reads were permitted as concordantly paired reads, --dovetail, as quality trimming may result in the extension of reads from their reading pair. 

All aligned reads with paired-end mapping were ranked based on their mapping quality. The best optimal read pair was marked as primary and recorded in the output SAM file. For library reads with multiple optimal alignment sites, one of the best alignment sites was randomly selected and marked as the primary alignment (-k 1). Thus, Bowtie2 generated an output SAM file containing all the primary alignment sites. The results were converted to BAM file format using samtools v1.15.0 (Danecek et al., 2021), with a coordinate sorted format, to reduce file size.

## Filtering of low quality reads before peak calling

ATAC-seq data is unfortunately subject to background noise and contamination. To remove mitochondrial contamination introduced during the ATAC-seq protocol, samtools view (Danecek et al., 2021) was used to filter out reads mapped to "chrM". Previous studies have reported that mitochondrial contamination may account for up to 80% of the sequencing library due to the lack of chromatin packaging in mitochondrial DNA (Bogenhagen, 2012; Montefiori et al., 2017). Removing mitochondrial reads reduces the computational requirements necessary for analysis and limits background-level interference during peak calling. After removal of mitochondrial reads, Picard MarkDuplicates v2.27.3 (Broad Institute, 2019) was used to eliminate PCR or optical duplications that may have occurred during sequencing. Picard MarkDuplicates compares the 5' position of the read and its read pair to enable paired-end deduplication. Duplicated fragments where the sum of base quality scores was highest were marked as primary reads and kept, while others (duplicates) were removed.

Finally, the ATAC-seq BAM files were filtered based on mapping quality and alignment properties. Reads with a mapping quality below 30 were eliminated from the file using samtools view (Danecek et al., 2021). This score was selected as Bowtie2 marks reads with multiple best alignment positions with a mapping score below 20. Therefore, this mapping score cutoff allows the removal of all reads with insufficient evidence of correct alignment position from consideration.

##	Peak calling using HMMRATAC model

Hidden Markov ModeleR for ATAC-seq (HMMRATAC) peak caller v1.2.10 (Tarbell and Liu, 2019), which was the only published package specialising in ATAC-seq peak calling at the time this study began, was selected to perform peak calling. HMMRATAC has been shown to adjust for sample-specific variability by employing a model training process, setting it apart from all other packages developed or modified for ATAC-seq analysis (Zhang et al., 2008; Li et al., 2019; Hentges et al., 2022; Vu et al., 2023; Gaspar, 2024). HMMRATAC uses a 10-bp resolution in peak calling and a broad peak strategy to minimise the influence of the 9-bp bias that is observed in ATAC-seq libraries, as a consequence of DNA repair processes employed during library preparation (Reznikoff, 2008; Calviello et al., 2019). 

The HMMRATAC algorithm begins with a model training process, during which it evaluates the distribution of fragment sizes in each sequencing library (Tarbell and Liu, 2019). ATAC-seq libraries have previously been reported to have a fragment size distribution in which fragments with sizes of 75, 200, 400, and 600 bp are more likely to be produced (Buenrostro et al., 2013a). This is due to the number of nucleosomes involved in generating the reads, with each fragment size containing zero, one, two, or three nucleosomes, respectively. However, the fragment size distribution is unique in each individual library. Thus, the HMMRATAC algorithm calculates this distribution by running a model fitting process using a subset of the input fragments (Tarbell and Liu, 2019).

The official peak calling process then occurs using the fragment size distribution model (Tarbell and Liu, 2019). All input reads are categorised into four groups, based on the fragment size model, as reads with shorter fragment lengths are enriched around the TSS (Ou et al., 2018). The HMMRATAC algorithm categorises genomic regions based on the types of fragments found in each region (Figure 2.3). Regions with a high enrichment of all fragment sizes are labelled as 'center', while regions with a low nucleosome-free fragment, but a high number of other fragments, are considered as 'nucleosome'. The 'background' category contains a low number of all fragments. Within this, a second training process is triggered to determine the cutoff between ‘nucleosome' and ‘center'. This training process involves comparing regions with a read coverage ten times higher than the adjacent ‘background' regions to the background region to determine the cutoff between ‘center’ and ‘nucleosome’.

Figure 2.3: Graphical representation of the algorithm for classification of genomic regions used by HMMRATAC. The upper portion shows the alignment of reads within specific genomic regions, while the lower portion illustrates different chromatin regions, as determined by HMMRATAC, based on the characteristics of the aligned reads. Figure created using IGV and Biorender.com.

After dividing the genomic regions into three categories, the accessible region (referred to as 'center') is merged with the supporting region ('nucleosome') and reported as gapped peaks. This is because the neighbouring regions of each accessible peak are believed to contribute to the regulation of chromatin accessibility (Dhaka and Sabarinathan, 2021). Finally, gapped peak locations are obtained for each sample and the base pair with the highest read coverage within the peak was recorded. Finally, regions on the ENCODE blacklist were excluded from the output peaks using the -e $blacklistFile flag because these regions have been shown to be consistently over-detected in genomic extraction protocols (Amemiya et al., 2019).

## Differential Accessibility Analysis

The chromatin accessibility peaks identified using HMMRATAC were used for differential accessibility analysis using DiffBind v3.6.5 (Stark and Brown, 2011), which employs a strategy similar to that of DESeq2 (Stark and Brown, 2011; Love et al., 2014). DiffBind was originally developed to analyse differential binding activity in ChIP-sequencing (ChIP-seq) experiments (Ross-Innes et al., 2012). However, it is commonly used as a tool for analysing chromatin accessibility changes in the absence of a similar, dedicated tool for ATAC-seq data (Reske et al., 2020). DiffBind measures changes in chromatin accessibility using a standardised, conserved peak set (Stark and Brown, 2011). This approach provides a more sample-specific adjustment for the differential accessibility analysis, while alternative tools such as csaw (Lun and Smyth, 2016) perform analysis within pre-set regions.

Prior to quantifying the reads mapped to each genomic region, a new peak set was generated using the dba.count command, taking into account the consistency of peaks across samples (Stark and Brown, 2011). Peak size and location may vary across replicates (Håndstad et al., 2012). Within HMMRATAC-estimated gapped peak locations, regions with limited accessibility were also included in the gapped regions. Thus, these regions with limited accessibility, which may not be accessible, will be investigated for differential analysis if overlapping peaks are simply merged (Reske et al., 2020). Therefore, to account for such variations, the dba.count function redefines the peak set by selecting a single base pair within the genomic location (ie. that with the highest read count) across all samples, for each queried peak (Stark and Brown, 2011). A 200 bp flanking region is added on either side of the selected genomic location to create a standardised peak set of 401 bp (Figure 2.4). To ensure consistency of peaks across conditions, only peaks that appear in at least two samples were considered for further analysis.

Figure 2.4: Graphical representation of the definition of standardised peaks, according to the DiffBind algorithm. Standardised peaks are estimated based on the gapped peak identified by the HMMRATAC algorithm. 200 bp flanking the base pair with the highest read coverage within each gapped peak are classified as the standardised peak. Figure created using Biorender.com.

In the second stage, a raw count matrix is created for each of the standardised peak regions (Stark and Brown, 2011). The dba.count command records the number of reads that overlap with the standardised peaks in each BAM file. This value is then used as the raw count value for each peak region. The raw count matrix is incorporated into a standard DESeq2 differential analysis protocol using the dba.contrast and dba.analyze functions. This includes normalising read counts to account for bias, shrinking dispersion to prevent false positives, conducting Wald tests, and shrinking log2(fold change). The results were extracted as a data frame, which reported the peak information, including the log2(fold change) and the significance value of each standardised peak using dba.report. Standardised peaks with a |L2FC| > 2 and p.adj < 0.05 was defined as being differentially accessible, indicating regions experiencing a change in chromatin accessibility due to PMA treatment. 

